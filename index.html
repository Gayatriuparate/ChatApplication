<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Masala-chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
    </style>
</head>

<body>
  <label id="username"></label>

  <div id="chat" style="height: 50vh;overflow: auto;">chat</div>
  <div id="users" style="height: 20vh;overflow: auto;">users</div>
  <form action="">
    <input id="m" autocomplete="off" /><input type="button" value="send" onclick="setChat();">
  </form>
  <script type="text/javascript">
    let activeUsers = document.getElementById("users");
    let chatSection = document.getElementById("chat");
    function setChat() {
      let msg = document.getElementById("m").value;
      let username = document.getElementById("username").innerText;
      var oReq = new XMLHttpRequest();
      oReq.open('POST', '/setChat', true);
      oReq.setRequestHeader('Content-type', 'text/plain');
      oReq.onreadystatechange = function () {//Call a function when the state changes.
        if (oReq.readyState == 4 && oReq.status == 200) {
          let result = JSON.parse(oReq.response);
          var text = document.createTextNode(msg);
          chatSection.appendChild(text);
        }
      };
      let user = sessionStorage.getItem("lastname").toString();
      let packet = { "u_name": username, "msg": msg, "loginuser": user };
      let data = JSON.stringify(packet);

      oReq.send(data);
    }
    function getChat() {
      let username = document.getElementById("username").innerText;
      var oReq = new XMLHttpRequest();
      oReq.open('POST', '/getChat', true);
      oReq.setRequestHeader('Content-type', 'text/plain');
      oReq.onreadystatechange = function () {//Call a function when the state changes.
        if (oReq.readyState == 4 && oReq.status == 200) {
          let result;
          if (oReq.response != '') {
            result = JSON.parse(oReq.response);
          }
          for (i = 0; i < result.length; i++) {
            var text = document.createTextNode(result[i]);
            chatSection.appendChild(document.createElement("br"));
            chatSection.appendChild(text);

          }
        }
      };
      let user = sessionStorage.getItem("lastname").toString();
      let packet = { "u_name": username, "loginuser": user };
      let data = JSON.stringify(packet);
      oReq.send(data);
    }

    function sendReq() {
      var oReq = new XMLHttpRequest();
      oReq.open('POST', '/user', true);
      let user = sessionStorage.getItem("lastname").toString();
      //Send the proper header information along with the request
      oReq.setRequestHeader('Content-type', 'text/plain');
      oReq.onreadystatechange = function () {
        //Call a function when the state changes.
        if (oReq.readyState == 4 && oReq.status == 200) {
          let result = JSON.parse(oReq.response);
          activeUsers.innerText = "";
          result.forEach(element => {
            if (element != user) {
              let button = document.createElement("button");
              let br = document.createElement("br");
              button.id = element;
              button.style.alignContent = 'left';
              var text = document.createTextNode(`chat with ${element}`);
              button.appendChild(text);
              button.onclick = () => {
                document.getElementById("username").innerText = element;
                console.log("before chat");
                clearInterval(chatinterval);
                chatinterval();
              };

              activeUsers.appendChild(br);
              activeUsers.appendChild(button);
            }
          });
        }
      }
      oReq.send("hi");
    }
    setInterval(() => {
      sendReq();
    }, 2000);
    let chatinterval = () => {
      setInterval(() => {
        getChat();
      }, 2000);
    };  
  </script>
</body>

</html>